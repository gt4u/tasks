# Работа с *WebHooks* AmoCrm через API с использованием приватных классов GT4U

#### Работа производится в аккаунте AmoCrm, который был создан в [задании № 2](https://github.com/gt4u/tasks/tree/master/task_2).

[Документация по работе с webhooks в AmoCrm](https://www.amocrm.ru/developers/content/api/webhooks-2).

В работе использовать библиотеки:
- *gt4u/amo_hooks_handler*;
- *gt4u/task_from_date*;
- *gt4u/task_from_status*;
- *gt4u/amocrm*;
- При необходимости зависимые библиотеки репозиториев выше.

### План выполнения:      

1. Настроить библиотеку *gt4u/amo_hooks_handler* для приема и обработки вебхуков от amoCRM;

1. Реализовать логику обработки веб-хуков в отдельных классах, вызывать их обработку библиотекой *gt4u/amo_hooks_handler*:
    - При создании сделки на этапэ *Новая заявка*:
        - Заполнить поле *бюджет* из рассчета - (Ширина * Высота)/100 руб. Если кол-во камер = 3, то полученную сумму увеличить на 50%. При выборе профиля = VEKA предоставляется скидка в размере 5000 рублей. Итоговой бюджет - это целое число без копеек.
        - Заполнить поле *Дата заявки* текущей датой в формате dd.mm.yyyy;
        - Заполнить поле *Замерщик*, необходимо реализовать очередь распределения заявок для всех значений поля. В первой созданной сделке Иванов, в следующей Петров и т. д.
    - При переходе сделки на этап *1_БП*:
        - Получить ID основного контакта, привязанного к сделке. Сменить ответственного за контакта ответственным за текущую сделку.
        - Сменить ответственного за сделку на *Администратора акаунта*;
        - Сменить этап сделки на *2_БП*;
        - Дать задачу в сделку с параметрами (*gt4u/task_from_status*):
            1. Тип задачи = связаться с клиентом;
            2. Текст задачи = Назначить время замера;
            3. Срок исполнения = 30 минут;
            4. Задачу дать через 5 минут после получения вебхука;
            5. Ответственный за задачу = текущий ответственный за сделку.
            
    - При переходе сделки на этап *2_БП*:
      - Если бюджет сделки >= 10000, то перевести её на этап *3_БП*, иначе добавить обычное примечание в сделку с текстом: "Низкий бюджет сделки, предложить клиенту доп. продукты";
      
    - При изменении поля *Дата замера* необходимо дать задачу в сделку с параметрами (*gt4u/task_from_date*):
        1. Тип задачи = Дата замера;
        2. Текст задачи = "{date} назначан замер, необходимо выехать к клиенту.", где {date} - это значение поля *Дата замера* в формате dd.mm.yyyy;
        3. Срок исполнения = до конца дня указанного в поле *Дата замера*;
        4. Если поле *Дата замера* изменилось, но задача уже давалась ранее - необходимо изменить прошлую задачу, а не создавать новую.
